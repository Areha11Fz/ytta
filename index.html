<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YTTA Voucher Dashboard</title>

    <!-- Tailwind CSS JIT CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gray: {
                            850: '#1f2937',
                            950: '#0d1117',
                        },
                    }
                }
            }
        }
    </script>

    <!-- DataTables Tailwind CSS -->
    <link rel="stylesheet" type="text/css"
        href="https://cdn.datatables.net/1.13.6/css/dataTables.tailwindcss.min.css" />

    <style>
        /* Custom scrollbar styles */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1f2937;
        }

        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        /* Smooth transition for the copy-on-click feedback */
        #vouchersTable tbody td {
            transition: background-color 0.15s ease-in-out;
        }

        /* Pagination ellipsis fix */
        .dataTables_wrapper .dataTables_paginate .paginate_button.disabled.ellipsis {
            pointer-events: none;
            cursor: default;
        }
    </style>

</head>

<body class="bg-gray-950 text-gray-200 antialiased">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">

        <div class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-white">YTTA Voucher Dashboard</h1>
            <p class="text-gray-400 mt-2">Buat Yang Tau Tau Aja üòÅ</p>
            <p class="text-gray-400 mt-2 text-sm">(Tips: Double Click to Copy, Hold Shift to Multi Order)</p>
        </div>

        <div class="bg-gray-850 shadow-lg rounded-lg p-4 sm:p-6">
            <!-- Container for column visibility toggles -->
            <div class="mb-4 border-b border-gray-700 pb-4">
                <strong class="text-gray-300 mr-4">Show/Hide Columns:</strong>
                <div id="column-toggle" class="inline-flex flex-wrap gap-x-4 gap-y-2">
                    <!-- Checkboxes will be inserted here -->
                </div>
            </div>

            <table id="vouchersTable" class="display nowrap" style="width:100%">
                <thead></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <!-- DataTables Core & Tailwind Integration JS -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.tailwindcss.min.js"></script>

    <script>
        $(document).ready(function () {

            // Helper functions (unchanged)
            function snakeToTitleCase(str) { return str.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' '); }
            function formatTimestamp(ts) { return new Date(ts * 1000).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }); }
            function formatCurrency(num) { return 'Rp ' + (num / 100000).toLocaleString('id-ID'); }

            // --- DYNAMIC TABLE INITIALIZATION ---
            $.ajax({
                url: "cleaned_vouchers.json",
                dataType: "json",
                success: function (json) {
                    let allVouchers = [];
                    for (const key in json) { allVouchers = allVouchers.concat(json[key]); }

                    const currentTimeInSeconds = Math.floor(Date.now() / 1000);
                    const activeVouchers = allVouchers.filter(v => v.end_time > currentTimeInSeconds);

                    if (activeVouchers.length === 0) {
                        $('#vouchersTable').html('<thead><tr><th>No Unexpired Vouchers Found</th></tr></thead>');
                        return;
                    }

                    // Column Visibility Logic (unchanged)
                    const visibilityStorageKey = 'yttaDashboard_columnVisibility';
                    const defaultHiddenColumns = ['promotion_id', 'signature', 'has_expired', 'claim_end_time'];
                    let savedVisibility = JSON.parse(localStorage.getItem(visibilityStorageKey));
                    let checkboxesHtml = '';

                    const headers = Object.keys(activeVouchers[0]);
                    let headerHtml = '<tr>';
                    const dtColumns = headers.map((key, index) => {
                        headerHtml += `<th class="text-left p-3">${snakeToTitleCase(key)}</th>`;
                        let isVisible;
                        if (savedVisibility) {
                            isVisible = savedVisibility[key] !== false;
                        } else {
                            isVisible = !defaultHiddenColumns.includes(key);
                        }
                        checkboxesHtml += `
                            <label class="inline-flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" data-column-index="${index}" data-column-key="${key}" ${isVisible ? 'checked' : ''} class="form-checkbox h-4 w-4 rounded bg-gray-700 border-gray-600 text-indigo-600 focus:ring-indigo-500">
                                <span class="text-gray-300 text-sm">${snakeToTitleCase(key)}</span>
                            </label>
                        `;
                        const columnDef = { data: key, className: 'p-3', visible: isVisible };

                        // Switch statement for renderers (unchanged)
                        switch (key) {
                            case 'link':
                                columnDef.render = (data) => `<a href="${data}" target="_blank" class="text-indigo-400 hover:text-indigo-300 font-semibold">Claim Voucher</a>`;
                                columnDef.orderable = false;
                                break;
                            case 'min_spend': case 'cap':
                                columnDef.render = formatCurrency;
                                break;
                            case 'percentage':
                                columnDef.className += ' text-center';
                                columnDef.render = function (data) {
                                    if (data >= 50) return `<span class="px-2 py-1 text-xs font-semibold text-green-100 bg-green-600 rounded-full">${data}%</span>`;
                                    return `${data}%`;
                                };
                                break;
                            case 'claim_start_time': case 'claim_end_time': case 'start_time': case 'end_time':
                                columnDef.render = formatTimestamp;
                                break;
                            case 'has_expired':
                                columnDef.className += ' text-center';
                                columnDef.render = (data) => data ? 'Yes' : 'No';
                                break;
                        }
                        return columnDef;
                    });
                    headerHtml += '</tr>';

                    $('#column-toggle').html(checkboxesHtml);
                    $('#vouchersTable thead').html(headerHtml);

                    const table = $('#vouchersTable').DataTable({
                        data: activeVouchers,
                        columns: dtColumns,
                        renderer: 'tailwindcss',
                        scrollX: true,
                        order: [[headers.indexOf('start_time'), "asc"]],
                        orderMulti: true,
                        pageLength: 10,
                        stateSave: true,

                        // Top-right pagination
                        // dom: '<"md:flex md:justify-between items-start mb-4"' +
                        //     'l' +
                        //     '<"flex flex-col items-end gap-2"fp>' +
                        //     '>' +
                        //     '<"overflow-x-auto"t>' +
                        //     '<"md:flex md:justify-between items-center mt-4"ip>'
                    });

                    setTimeout(() => table.columns.adjust(), 10);

                    // Event listener for checkboxes (unchanged)
                    $('#column-toggle').on('change', 'input[type="checkbox"]', function () {
                        const columnIndex = $(this).data('column-index');
                        const columnKey = $(this).data('column-key');
                        const isVisible = $(this).is(':checked');
                        table.column(columnIndex).visible(isVisible);
                        let currentVisibility = JSON.parse(localStorage.getItem(visibilityStorageKey)) || {};
                        currentVisibility[columnKey] = isVisible;
                        localStorage.setItem(visibilityStorageKey, JSON.stringify(currentVisibility));
                    });

                    // Double-click to copy logic (unchanged)
                    $('#vouchersTable tbody').on('dblclick', 'td', function () {
                        const cell = $(this);
                        const text = cell.text().trim();
                        if (text) {
                            navigator.clipboard.writeText(text).then(() => {
                                cell.addClass('!bg-green-700');
                                setTimeout(() => cell.removeClass('!bg-green-700'), 300);
                            }).catch(err => console.error('Failed to copy text: ', err));
                        }
                    });
                },
                error: function () {
                    $('#vouchersTable').html('<thead><tr><th>Error loading voucher data</th></tr></thead>');
                }
            });
        });
    </script>

</body>

</html>